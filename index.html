<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <meta name="format-detection" content="telephone=no,email=no,address=no"/>
  <meta name="color-scheme" content="light"/>
  <title>Яхтинг — заявка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @font-face{font-family:"BebasCustom";src:url("./fonts/Bebas.ttf?v=3") format("truetype");font-display:swap}
    @font-face{font-family:"RalewayCustom";src:url("./fonts/Raleway-Medium.ttf?v=3") format("truetype");font-display:swap}

    :root{--bg:#FFFFFF;--text:#231F20;--accent:#AC1F26;--muted:#6B7280;--radius:14px}
    *{box-sizing:border-box}html,body{height:100%}html,body{background:#FFFFFF!important}
    body{margin:0;font:16px/1.45 "RalewayCustom",system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);-webkit-text-size-adjust:100%;text-size-adjust:100%;overflow-x:hidden;touch-action:manipulation}

    .appbar{position:sticky;top:0;z-index:3;background:var(--accent);color:#fff;padding:14px 18px}
    .brand{font-family:"BebasCustom";letter-spacing:.5px;font-size:28px;line-height:1}
    .subtitle{opacity:.95;margin-top:4px;font-size:14px;font-weight:600;font-family:"RalewayCustom"}

    .container{max-width:720px;margin:0 auto;padding:16px;background:#FFFFFF}
    h2{margin:6px 0 8px;font-size:clamp(22px,4.5vw,32px);color:var(--accent);font-family:"BebasCustom";letter-spacing:.4px}
    label{display:block;margin:12px 0 6px;color:var(--accent);font-weight:700;font-family:"RalewayCustom"}
    input,textarea{width:100%;padding:12px 14px;border-radius:var(--radius);border:1px solid var(--accent);background:#FFFFFF;color:var(--text);outline:0;font-size:16px;font-family:"RalewayCustom"}
    input::placeholder,textarea::placeholder{color:var(--muted)}textarea{min-height:110px;resize:vertical}.hint{color:var(--muted);font-size:13px;margin-top:6px}

    .btnbar{position:sticky;bottom:0;z-index:2;padding:12px 16px env(safe-area-inset-bottom,0px);background:#FFFFFF;border-top:1px solid var(--accent)}
    .btn{width:100%;display:inline-block;text-align:center;padding:14px 16px;border-radius:var(--radius);border:0;cursor:pointer;background:var(--accent);color:#fff;font-weight:800;font-size:16px;letter-spacing:.2px;font-family:"RalewayCustom"}
    .btn[disabled]{opacity:.45;cursor:not-allowed}.btn:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="brand">ЯХТИНГ</div>
    <div class="subtitle">В Турции, по Эгейскому побережью</div>
  </header>

  <div class="container">
    <h2>Заявка на подбор тура</h2>
    <p id="who" class="hint">Загружаю…</p>

    <label>Имя*</label>
    <input id="name" placeholder="Как к вам обращаться"/>

    <label>Телефон/Telegram*</label>
    <input id="contact" placeholder="@username или номер"/>

    <label>Комментарий</label>
    <textarea id="comment" placeholder="Куда, когда, бюджет и пожелания"></textarea>

    <p class="hint">Нажмите «Отправить заявку» внизу.</p>
  </div>

  <div class="btnbar">
    <button id="sendBtn" class="btn" disabled>Отправить заявку</button>
  </div>

  <script>
    const tg = Telegram.WebApp; tg.ready();
    try{ tg.setBackgroundColor('#ffffff'); tg.setHeaderColor('#AC1F26'); }catch(_){}
    function hideMB(){ try{ tg.MainButton.setParams({text:"",is_visible:false,is_enabled:false}); tg.MainButton.hide(); }catch(_){}}; hideMB(); setTimeout(hideMB,150); setTimeout(hideMB,600);

    let lastTouchEnd=0;
    document.addEventListener("touchstart",e=>{ if(e.touches.length>1) e.preventDefault() },{passive:false});
    document.addEventListener("touchend",e=>{const n=Date.now(); if(n-lastTouchEnd<=300) e.preventDefault(); lastTouchEnd=n },{passive:false});
    document.addEventListener("gesturestart",e=>e.preventDefault());

    const u = tg.initDataUnsafe?.user; const userId = u?.id || null;
    document.getElementById('who').textContent = u ? `Вы: ${u.first_name} ${u.last_name||''} (@${u.username||'—'})`.trim() : 'Открыто в Telegram';

    const $name=document.getElementById('name'), $contact=document.getElementById('contact'), $comment=document.getElementById('comment'), $sendBtn=document.getElementById('sendBtn');
    const ok = ()=>{ try{ tg.showPopup({title:'Готово', message:'Заявка отправлена ✅'}); }catch(_){ alert('Заявка отправлена ✅') } }
    const er = (m)=>{ try{ tg.showPopup({title:'Ошибка', message:m}); }catch(_){ alert(m) } }
    const canSend = ()=> $name.value.trim().length>=2 && $contact.value.trim().length>=3;
    [$name,$contact,$comment].forEach(i=>i.addEventListener('input',()=>{$sendBtn.disabled=!canSend()})); $sendBtn.disabled=!canSend();

    const BACKEND_URL = "https://miniapp-backend-q7w0.onrender.com/tma/submit";

    async function submitForm(){
      if(!canSend()) return;
      const payload={ event:'lead', name:$name.value.trim(), contact:$contact.value.trim(), comment:$comment.value.trim(), ts:Date.now() };
      const qid = tg.initDataUnsafe?.query_id || null;

      try{
        const r = await fetch(BACKEND_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ query_id: qid, user_id: tg.initDataUnsafe?.user?.id || null, data: payload }),
          mode: 'cors',
        });
        const txt = await r.text().catch(()=> '');
        if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
        ok(); tg.close();
      }catch(e){ er(String(e)) }
    }
    $sendBtn.addEventListener('click', submitForm);
  </script>
</body>
</html>
