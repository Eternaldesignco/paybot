<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mar keTraveller — заявка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{--pad:16px}
    body{margin:0;background:var(--tg-theme-bg-color);color:var(--tg-theme-text-color);
         font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{background:#ac1f26;color:#fff;padding:16px 18px;font-weight:700;font-size:22px}
    .wrap{padding:var(--pad);max-width:640px;margin:0 auto}
    label{display:block;margin:12px 0 6px;opacity:.85}
    input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--tg-theme-hint-color);
                   background:var(--tg-theme-secondary-bg-color);color:var(--tg-theme-text-color)}
    textarea{min-height:96px;resize:vertical}
    .hint{opacity:.7;font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <header>MarkeTraveller</header>

  <div class="wrap">
    <h2>Заявка на подбор тура</h2>
    <p id="who" class="hint">Загружаю…</p>

    <label>Имя*</label>
    <input id="name" placeholder="Как к вам обращаться"/>

    <label>Телефон/Telegram*</label>
    <input id="contact" placeholder="@username или номер"/>

    <label>Комментарий</label>
    <textarea id="comment" placeholder="Куда, когда, бюджет и пожелания"></textarea>

    <p class="hint">Нажмите «Отправить» внизу.</p>
    <button id="send" style="display:none"></button> <!-- нужен для привязки onClick, но не показываем -->
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    // tg.expand(); // если на Desktop падал — оставь закомментированным

    // Кто открыл
    const u = tg.initDataUnsafe?.user;
    document.getElementById('who').textContent = u
      ? `Вы: ${u.first_name} ${u.last_name||''} (@${u.username||'—'})`.trim()
      : 'Открыто вне Telegram';

    const nameEl = document.getElementById('name');
    const contactEl = document.getElementById('contact');
    const commentEl = document.getElementById('comment');

    // ===== Главная кнопка Telegram (показываем ЯВНО) =====
    tg.MainButton.setText('Отправить заявку');
    tg.MainButton.show();            // <<< это делает кнопку видимой
    tg.MainButton.disable();         // включим после валидации

    function validate(){
      const ok = nameEl.value.trim().length>=2 && contactEl.value.trim().length>=3;
      if(ok) tg.MainButton.enable(); else tg.MainButton.disable();
    }
    [nameEl,contactEl,commentEl].forEach(i=>i.addEventListener('input', validate));
    validate();

    // ===== Отправка =====
    function send(payload){
      const qid = tg.initDataUnsafe?.query_id; // есть при запуске из меню/профиля/директ-линка
      if (qid) {
        // Сценарий «кнопка слева» — сейчас просто покажем подтверждение и закроем апп.
        // (Доставку в чат сделаем позже через маленький сервер — это нужно для Menu Button).
        try { tg.showPopup({title:'Готово', message:'Заявка отправлена ✅'}); } catch(e){}
        tg.close();
      } else {
        // Сценарий «кнопка снизу» (если когда-нибудь вернёшь) — шлём напрямую боту
        tg.sendData(JSON.stringify(payload));
        try { tg.showPopup({title:'Отправлено', message:'Данные ушли боту ✅'}); } catch(e){}
      }
    }

    tg.MainButton.onClick(() => {
      const payload = {
        event:'lead',
        name: nameEl.value.trim(),
        contact: contactEl.value.trim(),
        comment: commentEl.value.trim(),
        ts: Date.now()
      };
      send(payload);
    });
  </script>
</body>
</html>
