<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>MarkeTraveller — заявка</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font: 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color: var(--tg-theme-text-color);
      background: var(--tg-theme-bg-color);
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
    }
    header {
      position: sticky; top: 0; z-index: 2;
      background: #ac1f26; color: #fff; padding: 14px 18px;
      font-weight: 700; font-size: clamp(18px, 2.5vw, 22px);
    }
    .container { max-width: 720px; margin: 0 auto; padding: 16px; }
    h2 { margin: 6px 0 8px; font-size: clamp(18px, 3.5vw, 24px); }
    label { display:block; margin: 12px 0 6px; opacity:.9 }
    input, textarea {
      width: 100%; min-width: 0;
      padding: 12px 14px; border-radius: 12px;
      border: 1px solid var(--tg-theme-hint-color);
      background: var(--tg-theme-secondary-bg-color);
      color: var(--tg-theme-text-color);
      outline: none;
    }
    textarea { min-height: 100px; resize: vertical; }
    .hint { opacity:.7; font-size: 13px; margin-top: 6px; }
    footer { height: calc(env(safe-area-inset-bottom, 0px)); }
  </style>
</head>
<body>
  <header>MarkeTraveller</header>

  <div class="container">
    <h2>Заявка на подбор тура</h2>
    <p id="who" class="hint">Загружаю…</p>

    <label>Имя*</label>
    <input id="name" placeholder="Как к вам обращаться"/>

    <label>Телефон/Telegram*</label>
    <input id="contact" placeholder="@username или номер"/>

    <label>Комментарий</label>
    <textarea id="comment" placeholder="Куда, когда, бюджет и пожелания"></textarea>

    <p class="hint">Нажмите «Отправить заявку» внизу.</p>
  </div>

  <footer></footer>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // Не форсим expand на свежих версиях Desktop (иногда падает)
    if (!tg.isVersionAtLeast?.(7, 0)) { try { tg.expand(); } catch(_) {} }

    // Кто открыл
    const u = tg.initDataUnsafe?.user;
    document.getElementById('who').textContent =
      u ? `Вы: ${u.first_name} ${u.last_name||''} (@${u.username||'—'})`.trim()
        : 'Открыто вне Telegram (без данных пользователя)';

    // Поля
    const $name = document.getElementById('name');
    const $contact = document.getElementById('contact');
    const $comment = document.getElementById('comment');

    // Главная кнопка Telegram
    tg.MainButton.setText('Отправить заявку');
    tg.MainButton.show();
    tg.MainButton.disable();

    function validate(){
      const ok = $name.value.trim().length >= 2 && $contact.value.trim().length >= 3;
      if (ok) tg.MainButton.enable(); else tg.MainButton.disable();
    }
    [$name, $contact, $comment].forEach(i => i.addEventListener('input', validate));
    validate();

    // === BACKEND ===
    const BACKEND_URL = "https://miniapp-backend-q7w0.onrender.com/tma/submit"; // свой URL

    function showError(msg){
      try { tg.showPopup({title:"Ошибка", message: msg}); } catch(_) { alert(msg); }
    }
    function showOk(msg){
      try { tg.showPopup({title:"Готово", message: msg}); } catch(_) { alert(msg); }
    }

    tg.MainButton.onClick(async () => {
      const payload = {
        event: 'lead',
        name: $name.value.trim(),
        contact: $contact.value.trim(),
        comment: $comment.value.trim(),
        ts: Date.now()
      };

      const queryId = tg.initDataUnsafe?.query_id; // есть при запуске из меню/профиля/директ
      if (queryId) {
        try {
          const r = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query_id: queryId, data: payload })
          });
          const text = await r.text().catch(()=> "");
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${text.slice(0,200)}`);
          showOk('Заявка отправлена ✅');
          tg.close();
